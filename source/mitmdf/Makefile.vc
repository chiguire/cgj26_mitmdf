# Visual C++ Makefile for PDCurses - SDL2
#
# Usage: nmake -f [path\]Makefile.vc [DEBUG=Y] [DLL=Y] [WIDE=Y] [UTF8=Y]
#        [INFOEX=N] [target]
#
# where target can be any of:
# [all|demos|pdcurses.lib|testcurs.exe...]

O = obj
E = .exe
RM = del

!ifndef PDCURSES_SRCDIR
PDCURSES_SRCDIR = ..\PDCurses-2b6a9e9
!endif

osdir		= $(PDCURSES_SRCDIR)\sdl2
common		= $(PDCURSES_SRCDIR)\common

!include $(common)\libobjs.mif
!include $(osdir)\versions.mif

SDLBASE = $(PDCURSES_SRCDIR)\..\SDL2-2.32.10
MITMDF = mitdf$(E)
CUSTOM_INCLUDE = -Iinclude
PLATFORM = x86
SDL2_INCLUDE = -I$(SDLBASE)\include
SDL2_LIB = $(SDLBASE)\lib\$(PLATFORM)\SDL2.lib
SDL2_LIBMAIN = $(SDLBASE)\lib\$(PLATFORM)\SDL2main.lib

PDCURSES_WIN_H	= $(osdir)\pdcsdl.h

CC		= cl.exe -nologo

!ifdef DEBUG
CFLAGS		= -Z7 -DPDCDEBUG
LDFLAGS		= -debug -pdb:none
!else
CFLAGS		= -O1
LDFLAGS		=
!endif

!ifdef WIDE
WIDEOPT		= -DPDC_WIDE
TTF_INCLUDE	= -I$(TTFBASE)\include
TTF_LIB		= $(TTFBASE)\lib\$(PLATFORM)\SDL2_ttf.lib
!endif

!ifdef UTF8
UTF8OPT		= -DPDC_FORCE_UTF8
!endif

!ifdef INFOEX
INFOPT		= -DHAVE_NO_INFOEX
!endif

SHL_LD = link $(LDFLAGS) -nologo -dll -machine:$(PLATFORM) -out:pdcurses.dll

LINK		= link.exe -nologo -subsystem:windows

LIBEXE		= lib -nologo

LIBCURSES	= $(PDCURSES_SRCDIR)\sdl2\pdcurses.lib
CURSESDLL	= pdcurses.dll

!ifdef DLL
DLLOPT		= -DPDC_DLL_BUILD
PDCLIBS		= $(CURSESDLL)
LIBLIBS		= $(SDL2_LIB) $(TTF_LIB)
CCLIBS		= $(SDL2_LIBMAIN) $(SDL2_LIB) shell32.lib
!else
PDCLIBS		= $(LIBCURSES)
CCLIBS		= $(SDL2_LIBMAIN) $(SDL2_LIB) $(TTF_LIB) shell32.lib
!endif

BUILD		= $(CC) -I$(PDCURSES_SRCDIR) \
-c $(CFLAGS) $(DLLOPT) $(WIDEOPT) $(UTF8OPT) $(INFOPT)

all:	$(PDCLIBS)

clean:
	-$(RM) *.obj
	-$(RM) *.lib
	-$(RM) *.exe
	-$(RM) *.dll
	-$(RM) *.exp
	-$(RM) *.res

mitmdf: $(PDCLIBS) $(MITMDF) mitmdf.exe

demos:	$(PDCLIBS) $(DEMOS) sdltest.exe

DEMOOBJS = $(DEMOS:.exe=.obj) tui.obj sdltest.obj

$(LIBOBJS) $(PDCOBJS) : $(PDCURSES_HEADERS)
$(PDCOBJS) : $(PDCURSES_WIN_H)
$(DEMOOBJS) : $(PDCURSES_CURSES_H)
$(MITMDF) : $(LIBCURSES)
$(DEMOS) : $(LIBCURSES)
panel.obj : $(PANEL_HEADER)

!ifndef DLL
$(LIBCURSES) : $(LIBOBJS) $(PDCOBJS)
	$(LIBEXE) -out:$@ $(LIBOBJS) $(PDCOBJS)
!endif

$(CURSESDLL) : $(LIBOBJS) $(PDCOBJS) pdcurses.obj
	$(SHL_LD) $(LIBOBJS) $(PDCOBJS) pdcurses.obj $(LIBLIBS)

pdcurses.res pdcurses.obj: $(common)\pdcurses.rc
	rc -r -fopdcurses.res $(common)\pdcurses.rc
	cvtres -machine:$(PLATFORM) -nologo -out:pdcurses.obj pdcurses.res

{$(srcdir)\}.c{}.obj::
	$(BUILD) $<

{$(osdir)\}.c{}.obj::
	$(BUILD) -Dmain=SDL_main $(SDL2_INCLUDE) $(TTF_INCLUDE) $<

{$(demodir)\}.c{}.obj::
	$(BUILD) -Dmain=SDL_main $<

.obj.exe:
	$(LINK) $(LDFLAGS) $< $(LIBCURSES) $(CCLIBS)

main.obj: main.cpp 
	$(BUILD) -Dmain=SDL_main $(SDL2_INCLUDE) $(CUSTOM_INCLUDE) main.cpp

texts.obj: texts.cpp
	$(BUILD) -Dmain=SDL_main $(SDL2_INCLUDE) $(CUSTOM_INCLUDE) texts.cpp

game.obj: game.cpp
	$(BUILD) -Dmain=SDL_main $(SDL2_INCLUDE) $(CUSTOM_INCLUDE) game.cpp

mitmdf.exe: main.obj texts.obj game.obj
	$(LINK) $(LDFLAGS) main.obj texts.obj game.obj $(LIBCURSES) $(LIBLIBS) $(CCLIBS)